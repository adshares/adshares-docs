.. _protocol-payments-sending:

Sending payments
================

.. uml::
    :align: center

    skinparam monochrome true

    participant "ADS Blockchain"                    as blockchain
    participant "Demand-Side\nPlatform"             as DSP
    participant "Demand-Side\nContext Platform"     as DSCP
    participant "Ad Pay\nModule"                    as APM
    actor       "Advertiser"                        as advertiser

    advertiser -> DSP: Deposit funds
    loop every 1 hour
        DSP -> DSCP: Get\nUser/Site/Device\nContext
        DSCP --> DSP : User/Site/Device\nContext
        DSP -> APM: Generate Payment Report
        APM --> DSP: Payment Report
        DSP -> DSP: Calculate payments
        DSP -> blockchain: Send multi transaction
    end

:ref:`Demand-Side Platform <protocol-definitions-dsp>` is expected to pay for displayed/converted :ref:`Creatives <protocol-definitions-creative>`
by sending :ref:`ADS <protocol-definitions-ads>` payments to all :ref:`Supply-Side Platforms <protocol-definitions-ssp>` that have been involved
in handling those :ref:`Creatives <protocol-definitions-creative>`.

Every hour :ref:`Demand-Side Infrastructure <protocol-definitions-dsi>` generates a :ref:`Payment Report <protocol-definitions-paymentreport>`
which allocates the appropriate amount of :ref:`ADS <protocol-definitions-ads>` that :ref:`Demand-Side Platform <protocol-definitions-dsp>` needs to pay 
to all :ref:`Supply-Side Platforms <protocol-definitions-ssp>` for utilizing their :ref:`Sites <protocol-definitions-site>` within the last one-hour timeframe.

It's important for :ref:`Demand-Side Platform <protocol-definitions-dsp>` to store the generated :ref:`Payment Reports <protocol-definitions-paymentreport>` 
because :ref:`Supply-Side Platforms <protocol-definitions-ssp>` are expected to request those report upon receiving their payments.

The actual task of generating the :ref:`Payment Report <protocol-definitions-paymentreport>` is delegated 
by :ref:`Demand-Side Platform <protocol-definitions-dsp>` to its :ref:`Ad Pay Module <protocol-definitions-apm>`.

However, to complete this task :ref:`Ad Pay Module <protocol-definitions-apm>` needs to receive 
from :ref:`Demand-Side Platform <protocol-definitions-dsp>` the following information:

* All :ref:`Impression Events <protocol-definitions-impression>` received by :ref:`Demand-Side Platform <protocol-definitions-dsp>` 
  from all :ref:`Supply-Side Agents <protocol-definitions-ssa>` associated with a given :ref:`Supply-Side Platform <protocol-definitions-ssp>`
  within the last one-hour timeframe.
* The corresponding :ref:`Context Data <protocol-definitions-contextdata>` retrieved by :ref:`Demand-Side Platform <protocol-definitions-dsp>` 
  from its :ref:`Context Platform <protocol-definitions-cp>` in order to match those :ref:`Impression Events <protocol-definitions-impression>`
  with specific :ref:`Users <protocol-definitions-user>`, :ref:`Sites <protocol-definitions-site>` and :ref:`Devices <protocol-definitions-device>`.

A :ref:`Payment Report <protocol-definitions-paymentreport>` generated by :ref:`Ad Pay Module <protocol-definitions-apm>` 
becomes the basis for :ref:`Demand-Side Platform <protocol-definitions-dsp>` to proceed with executing payments.
:ref:`Demand-Side Platform <protocol-definitions-dsp>` sends an :ref:`ADS <protocol-definitions-ads>` payment to a given 
:ref:`Supply-Side Platform <protocol-definitions-ssp>`, by transferring the appropriate amount of :ref:`ADS <protocol-definitions-ads>` 
to the :ref:`Supply-Side Platform <protocol-definitions-ssp>`'s :ref:`ADS Account <protocol-definitions-account>` address.

.. note::
  :ref:`Demand-Side Platform <protocol-definitions-dsp>` knows the :ref:`ADS Account <protocol-definitions-account>` 
  address of a given :ref:`Supply-Side Platform <protocol-definitions-ssp>`, as it has already been retrieved 
  during the :doc:`Synchronization <../synchronization/index>` stage.
  
The recommended operation for sending :ref:`ADS <protocol-definitions-ads>` payments is :ref:`send_many <send_many>`.
