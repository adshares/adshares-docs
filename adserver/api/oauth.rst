OAuth 2.0
===========

AdServer has a built-in OAuth2 server thanks to `Laravel Passport <https://laravel.com/docs/passport>`_.

AdServer supports two methods of acquiring an access token:

- ``client credentials grant`` - for machine access, e.g. third party integrations
- ``authorization code grant`` - for server applications with user interaction, e.g. AdController

In both methods client servers are responsible for secure storage of **CLIENT_ID** and **CLIENT_SERVER** generated by AdServer's operator.

Client credentials grant
--------------------------

This flow consist of single request for token.

.. http:post:: /oauth/token

    Acquires access token

    :reqheader Content-Type: ``application/x-www-form-urlencoded``

    :statuscode 200: no error

    :form grant_type: (constant) ``client_credentials``
    :form client_id: **CLIENT_ID**
    :form client_secret: **CLIENT_SERVER**
    :form scope: (optional) comma-separated scope of token

    **Example response**:

    .. sourcecode:: http

        HTTP/1.1 200 OK
        Content-Type: application/json

        {
            "token_type": "Bearer",
            "expires_in": 31536000,
            "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJtZXNzYWdlIjogIkJlZXIgYW5kIGNoZWVzZSBteSBmcmllbmQifQ.A2lO5mO7R8LLAKAXNvmAsVAPOJBc"
        }


Authorization code grant
--------------------------

Below is the sample flow in which AdController is the client server.
This flow is divided into sections but represents single authentication process.

.. uml::
    :align: center

    skinparam monochrome true

    actor       "User"         as user
    participant "AdController" as adcontroller
    participant "AdPanel"      as adpanel
    participant "AdServer"     as adserver

    ==Fetch data (no token)==
    user -> adcontroller: Open page
    adcontroller -> adserver: Fetch data
    adserver -> adcontroller: Unauthenticated 401
    ==Fetch code==
    adcontroller -> adserver: Fetch code
    adserver -> adpanel: Display log in form
    adpanel -> user: Log in form
    user -> adpanel: Log in credentials
    adpanel -> adserver: Log in
    adserver -> adpanel: Do redirect
    adpanel -> adserver: Redirect
    adserver -> adcontroller: Code

    ==Fetch access token==
    adcontroller -> adserver: Fetch token
    adserver -> adcontroller: Token
    ==Fetch data (token)==
    adcontroller -> adserver: Fetch data
    adserver -> adcontroller: Data
    adcontroller -> user: Display page
